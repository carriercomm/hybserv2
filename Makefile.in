# Hybserv Makefile by Hybserv2 team
# $Id$

# This is installation prefix. It can be overrided by passing PREFIX
# argument to make, as in making a fake tree for binary package.
PREFIX = @prefix@

# Set this to the directory to install the hybserv binary
BINDIR = $(PREFIX)/hybserv

# Set this to the directory to install hybserv.conf, motd.dcc, etc
CONFDIR = $(PREFIX)/hybserv

# Set this to the directory to install help files 
# (should match HelpPath in settings.conf)
HELPDIR = $(PREFIX)/hybserv/help

############ Don't change anything below here ############

# Hybserv2 Version
REVISION = @ac_cv_revision@
VERSION = 1.9.0-svn-${REVISION}

# Programs and params
RM = @RM@ -f
RMR = @RM@ -rf
CP = @CP@
CPR = @CP@ -R
LN = @LN@ -sf
INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@
INSTALL_BIN = ${INSTALL} -m 755
INSTALL_SECURE = ${INSTALL} -m 600

# Executable programs
BINPROGS = cleandb encryptconf encryptdb mkpasswd servchk \
					 finddupe fixalvl
# Secure configuration files (mode 600)
SECUREFILES = hybserv.conf settings.conf jupes.conf glines.conf
# General configuration files
CONFFILES = motd.dcc motd.global
# File containing HPath variable
HPATHFIX = settings.conf

# Subdirs for make
SUBDIRS = src tools

# Rest of standard Makefile
all: depend src tools
	@for i in $(SUBDIRS); do \
		echo "*** Building $$i ***"; \
		cd $$i; \
		${MAKE} "VERSION=$(VERSION)"; \
		cd ..; \
		echo; \
	done

build: all

clean:
	@echo '** Begin cleaning and removing objects **'
	@for i in $(SUBDIRS); do \
		echo "*** Cleaning $$i ***"; \
		cd $$i; \
		${MAKE} clean; \
		cd ..; \
		echo; \
	done

distclean: clean
	@echo '*** Removing objects and misc files ***'
	$(RM) `find . -type f -name Makefile -print` include/defs.h \
		include/config.h bin/settings.conf bin/cleandb \
		config.status src/.depend config.cache config.log ~* core \
		hybserv.core `find . -type f -size 0 -print`
	$(RM) `find . -type f \( -name '*.orig' -o -name '*.rej' -o -name '*~' \
		-o -name '*.bak' -o -name '.#*' -o -name '#*#' -o -name '.*.orig' \
		-o -name '.*.rej' -o -name '*.da' -o -name '.SUMS' -o -size 0 \) -print`

mrproper: distclean

depend:
	@echo '*** Making dependancies ***'
	@if test ! -f src/.depend; then \
		touch src/.depend; \
		cd src; $(MAKE) depend; \
		echo; \
	fi

install: all install-binary install-help
	@echo "*** Done installing Hybserv2 $(VERSION) ***"

install-binary:
	@if test ! -d $(BINDIR); then \
		echo Creating $(BINDIR); \
		mkdir $(BINDIR) 2>/dev/null; \
	fi
	@if test ! -d $(CONFDIR); then \
		echo Creating $(CONFDIR); \
		mkdir $(CONFDIR) 2>/dev/null; \
	fi
	@echo '** Installing Hybserv2 in $(BINDIR) **'
	@$(INSTALL_BIN) "bin/hybserv" "$(BINDIR)/hybserv"
	@for file in $(BINPROGS); do \
		echo "** Installing $$file in $(BINDIR) **"; \
		$(INSTALL_BIN) "bin/$$file" "$(BINDIR)/$$file"; \
	done
	@for file in $(SECUREFILES); do \
		if test ! -f "$(CONFDIR)/$$file"; then \
			echo "** Installing $$file in $(CONFDIR) **"; \
			$(INSTALL_SECURE) "bin/$$file" "$(CONFDIR)/$$file"; \
		fi \
	done
	@for file in $(CONFFILES); do \
		if test ! -f "$(CONFDIR)/$$file"; then \
			echo "** Installing $$file in $(CONFDIR) **"; \
			$(INSTALL_DATA) "bin/$$file" "$(CONFDIR)/$$file"; \
		fi \
	done
	@$(RM) $(BINDIR)/shownicks $(BINDIR)/showchans
	@echo '** Creating $(BINDIR)/shownicks **'
	@$(LN) $(BINDIR)/hybserv $(BINDIR)/shownicks
	@echo '** Creating $(BINDIR)/showchans **'
	@$(LN) $(BINDIR)/hybserv $(BINDIR)/showchans
	@echo

install-help:
	@if test ! -d $(HELPDIR); then \
		echo Creating $(HELPDIR); \
		mkdir $(HELPDIR) 2>/dev/null; \
	else \
		echo Removing old $(HELPDIR); \
		$(RMR) $(HELPDIR); \
		mkdir $(HELPDIR) 2>/dev/null; \
	fi
	@echo Installing help files in $(HELPDIR)
	@$(CPR) help/* $(HELPDIR)
	@echo

# Autoconf stuff
autoconf:
	autoreconf

# End of Makefile
# vim: set noexpandtab
